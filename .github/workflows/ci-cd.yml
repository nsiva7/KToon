name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "ci-cd-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  # Test on every push/PR
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Run tests
        run: ./gradlew test

      - name: Build library
        run: ./gradlew build

  # Check if we need to create a release (only on main branch)
  check-release:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      should-release: ${{ steps.check-release.outputs.should-release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from build.gradle.kts
        id: get-version
        run: |
          VERSION=$(grep '^version = ' build.gradle.kts | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"

      - name: Check if release exists
        id: check-release
        run: |
          VERSION=${{ steps.get-version.outputs.version }}
          if gh release view "v$VERSION" >/dev/null 2>&1; then
            echo "Release v$VERSION already exists"
            echo "should-release=false" >> $GITHUB_OUTPUT
          else
            echo "Release v$VERSION does not exist - will create release"
            echo "should-release=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Create release (only when release doesn't exist)
  create-release:
    runs-on: ubuntu-latest
    needs: [test, check-release]
    if: needs.check-release.outputs.should-release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build release artifacts
        run: ./gradlew build

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.check-release.outputs.version }}"
          
          # Get the latest tag (if any)
          LATEST_TAG=$(git tag --sort=-version:refname | head -n1)
          
          if [ -z "$LATEST_TAG" ]; then
            # First release
            cat > changelog.md << 'CHANGELOG_EOF'
          ## üéâ Initial Release
          
          This is the first release of KToon - Enhanced Kotlin implementation of TOON format with full encode/decode support.
          
          ### ‚ú® Features
          - üéØ **Complete TOON Implementation**: Both encoding and decoding support
          - üíæ **Type-Safe Conversions**: Decode to Kotlin data classes with reified generics
          - üîÑ **Bidirectional**: Seamless conversion between TOON, JSON, and Kotlin objects
          - üìä **Tabular Arrays**: Efficient handling of structured data
          - ‚öôÔ∏è **Configurable Options**: Custom delimiters, indentation, and length markers
          - ‚òï **Java Interop**: Full compatibility with Java projects
          - üß™ **Comprehensive Tests**: 45+ test cases with 100% round-trip validation
          
          ### üì¶ Installation
          ```kotlin
          repositories {
              maven("https://jitpack.io")
          }
          
          dependencies {
              implementation("com.github.nsiva7:KToon:$VERSION")
          }
          ```
          
          ### üöÄ Quick Start
          ```kotlin
          // Encoding
          val toonString = KToon.encode(myObject)
          
          // Decoding
          val myObject: MyClass = KToon.decode(toonString)
          ```
          
          ### üåê Documentation
          Visit our website: https://nsiva7.github.io/KToon
          CHANGELOG_EOF
          else
            # Generate changelog from commits since last tag
            cat > changelog.md << CHANGELOG_EOF
          ## üîÑ Changes since $LATEST_TAG
          
          $(git log $LATEST_TAG..HEAD --pretty=format:'- %s' --no-merges)
          
          ### üì¶ Installation
          \`\`\`kotlin
          repositories {
              maven("https://jitpack.io")
          }
          
          dependencies {
              implementation("com.github.nsiva7:KToon:$VERSION")
          }
          \`\`\`
          
          ### üåê Documentation
          Visit our website: https://nsiva7.github.io/KToon
          CHANGELOG_EOF
          fi
          
          # Set output
          echo "CHANGELOG_CONTENT<<CHANGELOG_EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "CHANGELOG_EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ needs.check-release.outputs.version }}"
          name: "KToon v${{ needs.check-release.outputs.version }}"
          body: ${{ steps.changelog.outputs.CHANGELOG_CONTENT }}
          artifacts: "build/libs/*.jar"
          generateReleaseNotes: true
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on commit
        run: |
          VERSION="${{ needs.check-release.outputs.version }}"
          cat > comment.md << 'COMMENT_EOF'
          üéâ **Released as [v$VERSION](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)**

          üì¶ **Installation:**
          ```kotlin
          implementation("com.github.nsiva7:KToon:$VERSION")
          ```

          üîó **Links:**
          - üì¶ [JitPack](https://jitpack.io/#nsiva7/KToon/$VERSION)
          - üåê [Website](https://nsiva7.github.io/KToon)
          - üìã [Release Notes](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)
          COMMENT_EOF
          
          gh api repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
            --method POST \
            --field body="$(cat comment.md)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build and deploy GitHub Pages (on README changes or releases)
  build-pages:
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main' && (contains(github.event.head_commit.modified, 'README.md') || needs.create-release.result == 'success')
    needs: [create-release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create docs directory
        run: mkdir -p docs

      - name: Generate website from README
        run: |
          # Create index.html from README.md
          cat > docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>KToon - Token-Oriented Object Notation (Kotlin)</title>
              <link rel="icon" href="https://kotlinlang.org/assets/images/favicon.svg" type="image/svg+xml">
              
              <!-- Tailwind CSS -->
              <script src="https://cdn.tailwindcss.com"></script>
              
              <!-- Prism.js for syntax highlighting -->
              <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
              <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-kotlin.min.js"></script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
              
              <!-- Marked.js for markdown parsing -->
              <script src="https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js"></script>
              
              <style>
                  .gradient-bg {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  }
                  
                  .hero-gradient {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
                      position: relative;
                      overflow: hidden;
                  }
                  
                  .hero-gradient::before {
                      content: '';
                      position: absolute;
                      top: 0;
                      left: 0;
                      right: 0;
                      bottom: 0;
                      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="%23ffffff10"><polygon points="0,100 1000,0 1000,100"/></svg>') no-repeat center bottom;
                      background-size: cover;
                  }
                  
                  .code-block {
                      background: #2d2d2d;
                      border-radius: 8px;
                      padding: 1rem;
                      margin: 1rem 0;
                      overflow-x: auto;
                  }
                  
                  .toon-highlight {
                      background: linear-gradient(120deg, #f093fb 0%, #f5576c 100%);
                      -webkit-background-clip: text;
                      -webkit-text-fill-color: transparent;
                      background-clip: text;
                      font-weight: bold;
                  }
                  
                  .hero-content {
                      position: relative;
                      z-index: 10;
                  }
                  
                  .feature-card {
                      background: rgba(255, 255, 255, 0.95);
                      backdrop-filter: blur(10px);
                      border: 1px solid rgba(255, 255, 255, 0.2);
                      transition: all 0.3s ease;
                  }
                  
                  .feature-card:hover {
                      transform: translateY(-2px);
                      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
                  }
                  
                  .floating-icon {
                      animation: float 6s ease-in-out infinite;
                  }
                  
                  @keyframes float {
                      0%, 100% { transform: translateY(0px); }
                      50% { transform: translateY(-10px); }
                  }
                  
                  .version-badge {
                      display: inline-block;
                      background: rgba(255, 255, 255, 0.2);
                      padding: 0.5rem 1rem;
                      border-radius: 50px;
                      backdrop-filter: blur(10px);
                      border: 1px solid rgba(255, 255, 255, 0.3);
                  }
              </style>
          </head>
          <body class="bg-gray-50 text-gray-800">
              <!-- Header -->
              <header class="hero-gradient text-white py-20 min-h-screen flex items-center">
                  <div class="container mx-auto px-6">
                      <div class="hero-content text-center">
                          <!-- Logo and Title -->
                          <div class="mb-8">
                              <div class="flex items-center justify-center mb-6">
                                  <div class="floating-icon">
                                      <img src="https://kotlinlang.org/assets/images/favicon.svg" alt="Kotlin" class="w-16 h-16 mr-4">
                                  </div>
                                  <h1 class="text-6xl md:text-7xl font-bold tracking-tight">
                                      K<span class="toon-highlight">Toon</span>
                                  </h1>
                              </div>
                              <div class="version-badge mb-6">
                                  <img src="https://jitpack.io/v/nsiva7/KToon.svg" alt="Latest Version" class="inline">
                              </div>
                          </div>
                          
                          <!-- Tagline -->
                          <div class="mb-12">
                              <p class="text-2xl md:text-3xl mb-4 font-light">Token-Oriented Object Notation</p>
                              <p class="text-lg md:text-xl opacity-90 max-w-3xl mx-auto leading-relaxed">
                                  üöÄ Enhanced Kotlin implementation with <strong>DecodeOptions</strong> support<br>
                                  üíé Reduce LLM tokens by 30-60% while maintaining perfect readability
                              </p>
                          </div>
                          
                          <!-- Feature Highlights -->
                          <div class="grid md:grid-cols-3 gap-6 mb-12 max-w-5xl mx-auto">
                              <div class="feature-card rounded-xl p-6">
                                  <div class="text-3xl mb-3">üéØ</div>
                                  <h3 class="text-gray-800 font-semibold text-lg mb-2">Bidirectional</h3>
                                  <p class="text-gray-600 text-sm">Full encode & decode with custom options</p>
                              </div>
                              <div class="feature-card rounded-xl p-6">
                                  <div class="text-3xl mb-3">‚öôÔ∏è</div>
                                  <h3 class="text-gray-800 font-semibold text-lg mb-2">Configurable</h3>
                                  <p class="text-gray-600 text-sm">Custom delimiters, length markers & more</p>
                              </div>
                              <div class="feature-card rounded-xl p-6">
                                  <div class="text-3xl mb-3">‚òï</div>
                                  <h3 class="text-gray-800 font-semibold text-lg mb-2">Java Ready</h3>
                                  <p class="text-gray-600 text-sm">Seamless interoperability with Java projects</p>
                              </div>
                          </div>
                          
                          <!-- Action Buttons -->
                          <div class="flex flex-wrap justify-center gap-4 mb-8">
                              <a href="https://github.com/nsiva7/KToon" class="bg-white text-purple-600 px-8 py-4 rounded-full font-semibold hover:bg-gray-100 hover:shadow-lg transition-all duration-300 transform hover:scale-105">
                                  üìö View on GitHub
                              </a>
                              <a href="https://jitpack.io/#nsiva7/KToon" class="bg-purple-600 text-white px-8 py-4 rounded-full font-semibold hover:bg-purple-700 hover:shadow-lg transition-all duration-300 transform hover:scale-105">
                                  üì¶ Get from JitPack
                              </a>
                              <a href="https://github.com/nsiva7/KToon/releases" class="bg-green-600 text-white px-8 py-4 rounded-full font-semibold hover:bg-green-700 hover:shadow-lg transition-all duration-300 transform hover:scale-105">
                                  üöÄ Latest Release
                              </a>
                          </div>
                          
                          <!-- Quick Install -->
                          <div class="max-w-2xl mx-auto">
                              <p class="text-lg mb-4 opacity-90">Quick Install:</p>
                              <div class="bg-black bg-opacity-30 rounded-lg p-4 backdrop-filter backdrop-blur-lg border border-white border-opacity-20">
                                  <code class="text-green-300 font-mono">implementation("com.github.nsiva7:KToon:latest")</code>
                              </div>
                          </div>
                      </div>
                  </div>
              </header>

              <!-- Main Content -->
              <main class="container mx-auto px-6 py-12">
                  <div id="content" class="prose prose-lg max-w-none">
                      <div class="text-center py-8">
                          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto"></div>
                          <p class="mt-4 text-gray-600">Loading documentation...</p>
                      </div>
                  </div>
              </main>

              <!-- Footer -->
              <footer class="bg-gray-800 text-white py-12">
                  <div class="container mx-auto px-6 text-center">
                      <p>&copy; 2025 <a href="https://nsiva7.github.io" class="hover:text-purple-400">Siva Nimmala</a>. Licensed under MIT.</p>
                      <p class="mt-2">Enhanced Kotlin implementation with DecodeOptions support. Built with ‚ù§Ô∏è using TOON format by Johann Schopplich</p>
                  </div>
              </footer>

              <script>
                  // Fetch and render README content
                  fetch('https://raw.githubusercontent.com/nsiva7/KToon/main/README.md')
                      .then(response => response.text())
                      .then(markdown => {
                          // Configure marked options
                          marked.setOptions({
                              highlight: function(code, lang) {
                                  if (lang && Prism.languages[lang]) {
                                      return Prism.highlight(code, Prism.languages[lang], lang);
                                  }
                                  return code;
                              },
                              breaks: true,
                              gfm: true
                          });
                          
                          // Convert markdown to HTML
                          let html = marked.parse(markdown);
                          
                          // Custom processing for better styling
                          html = html.replace(/<h1>/g, '<h1 class="text-4xl font-bold text-center mb-8 toon-highlight">');
                          html = html.replace(/<h2>/g, '<h2 class="text-3xl font-bold mt-12 mb-6 text-purple-800">');
                          html = html.replace(/<h3>/g, '<h3 class="text-2xl font-semibold mt-8 mb-4 text-purple-700">');
                          
                          // Style code blocks
                          html = html.replace(/<pre><code class="language-(\w+)">/g, '<div class="code-block"><pre><code class="language-$1">');
                          html = html.replace(/<\/code><\/pre>/g, '</code></pre></div>');
                          
                          // Hide the title since we have it in header
                          html = html.replace(/<h1[^>]*>.*?<\/h1>/s, '');
                          
                          // Insert the processed HTML
                          document.getElementById('content').innerHTML = html;
                          
                          // Re-run Prism highlighting
                          Prism.highlightAll();
                      })
                      .catch(error => {
                          console.error('Error loading README:', error);
                          document.getElementById('content').innerHTML = '<p class="text-red-600 text-center">Error loading content. Please check the <a href="https://github.com/nsiva7/KToon" class="text-purple-600 hover:text-purple-800">GitHub repository</a>.</p>';
                      });
              </script>
          </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

  # Deploy to GitHub Pages
  deploy-pages:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-pages
    if: needs.build-pages.result == 'success'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4